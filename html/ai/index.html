<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="science.css"/>
  <title>Talk to Ollama</title>
</head>
<body>
<div class="background"></div>
  
<div class="Hotbg ">
  <input class="Hotbg-txt" id="msg" placeholder="Ask me anything">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<button class="Hotbg-btn search-btn" onclick="sendMessage()">
  <i class="fas fa-search"></i>
</button>

</div>

  <!-- This is where messages appear -->
 <!-- This is where messages appear -->
<div id="chat-container" style="position:absolute; top:70%; left:50%; transform:translateX(-50%); width:80%; max-height:200px; overflow-y:auto; color:white;">

</div>

<script>
const chatContainer = document.getElementById("chat-container");

function escapeHTML(str) {
  return str.replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
}

function sendMessage() {
  const msgInput = document.getElementById("msg");
  const message = msgInput.value.trim();
  if (!message) return;

  // User message
  const userDiv = document.createElement("div");
  userDiv.className = "message user";
  userDiv.textContent = message;
  chatContainer.appendChild(userDiv);

  // Bot container


  const es = new EventSource(`/api/chat/stream?message=${encodeURIComponent(message)}`);
  let receivedText = "";
  const botDiv = document.createElement("div");
  botDiv.className = "message bot";
  const cursor = document.createElement("span");
  cursor.className = "typing-cursor";
  botDiv.appendChild(cursor);
  chatContainer.appendChild(botDiv);

  es.onmessage = (event) => {
    if (event.data === "" || event.type === "done") {
      es.close();
      cursor.remove();

      // Remove any triple backticks
  const codeBlockRegex = /```([\s\S]*?)```/g;
  let lastIndex = 0;
  let match;

  while ((match = codeBlockRegex.exec(es)) !== null) {
    // Add text before code block
    if (match.index > lastIndex) {
      const textDiv = document.createElement("div");
      textDiv.className = "message bot";
      textDiv.textContent = es.slice(lastIndex, match.index).trim();
      chatContainer.appendChild(textDiv);
    }

    // Create code box
    const codeBox = document.createElement("pre");
    const codeElem = document.createElement("code");
    codeElem.textContent = match[1].trim(); // <-- use textContent instead of innerHTML
    codeBox.appendChild(codeElem);

    // Copy button
    const copyBtn = document.createElement("button");
    copyBtn.className = "copy-btn";
    copyBtn.textContent = "Copy";
    copyBtn.onclick = () => {
      navigator.clipboard.writeText(codeElem.textContent); // copy textContent
      copyBtn.textContent = "Copied!";
      setTimeout(() => copyBtn.textContent = "Copy", 1000);
    };

    // Wrap in bot div
    const wrapper = document.createElement("div");
    wrapper.className = "message bot";
    wrapper.appendChild(codeBox);
    wrapper.appendChild(copyBtn);
    chatContainer.appendChild(wrapper);

    lastIndex = match.index + match[0].length;
  }

  // Add remaining text after last code block
  if (lastIndex < es.length) {
    const textDiv = document.createElement("div");
    textDiv.className = "message bot";
    textDiv.textContent = es.slice(lastIndex).trim();
    chatContainer.appendChild(textDiv);
  }

  msgInput.value = "";
  chatContainer.scrollTop = chatContainer.scrollHeight;

      // Detect code patterns
      
      return;
    }

    receivedText += event.data;
    botDiv.textContent += event.data;
    chatContainer.scrollTop = chatContainer.scrollHeight;
  };

  es.onerror = () => {
    es.close();
    cursor.remove();
  };
}
</script>


</body>
</html>
