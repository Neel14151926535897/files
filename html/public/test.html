<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Simple ChatGPT Interface</title>
  <link rel="stylesheet" href="science.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { background:#222; color:white; font-family: monospace; margin:0; padding:0; }
    .Hotbg { position:fixed; top:10px; left:50%; transform:translateX(-50%); display:flex; gap:5px; }
    .Hotbg input { padding:5px 10px; width:300px; border-radius:5px; border:none; }
    .Hotbg button { padding:5px 10px; border-radius:5px; border:none; background:#555; color:white; cursor:pointer; }
    #chat-container { position:absolute; top:60px; left:50%; transform:translateX(-50%); width:80%; max-height:80vh; overflow-y:auto; }
    .message { margin:5px 0; padding:5px 10px; border-radius:5px; }
    .user { background:#444; text-align:right; }
    .bot { background:#333; text-align:left; }
    pre { background:#111; padding:10px; border-radius:5px; overflow-x:auto; margin:0; }
    button.copy-btn { margin-top:5px; padding:2px 5px; cursor:pointer; background:#555; color:white; border:none; border-radius:3px; display:inline-block; }
    .typing-cursor { display:inline-block; width:2px; background:white; animation: blink 1s infinite; }
    @keyframes blink { 0%,50%,100% {opacity:1;} 25%,75% {opacity:0;} }
  </style>
</head>
<body>

<div class="Hotbg">
  <input id="msg" placeholder="Ask me anything">
  <button onclick="sendMessage()"><i class="fas fa-search"></i></button>
</div>

<div id="chat-container"></div>

<script>
const chatContainer = document.getElementById("chat-container");

function escapeHTML(str) {
  return str.replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
}

function sendMessage() {
  const msgInput = document.getElementById("msg");
  const message = msgInput.value.trim();
  if (!message) return;

  // User message
  const userDiv = document.createElement("div");
  userDiv.className = "message user";
  userDiv.textContent = message;
  chatContainer.appendChild(userDiv);
  msgInput.value = "";

  // Bot container
  const botDiv = document.createElement("div");
  botDiv.className = "message bot";
  const cursor = document.createElement("span");
  cursor.className = "typing-cursor";
  botDiv.appendChild(cursor);
  chatContainer.appendChild(botDiv);

  let receivedText = "";

  const es = new EventSource(`/api/chat/stream?message=${encodeURIComponent(message)}`);

  es.onmessage = (event) => {
    if (event.data === "" || event.type === "done") {
      es.close();
      cursor.remove();

      // Split response into code blocks and plain text
      const codeBlockRegex = /```([\s\S]*?)```/g;
      let lastIndex = 0;
      let match;

      while ((match = codeBlockRegex.exec(receivedText)) !== null) {
        // Plain text before code block
        if (match.index > lastIndex) {
          const textDiv = document.createElement("div");
          textDiv.className = "message bot";
          textDiv.textContent = receivedText.slice(lastIndex, match.index).trim();
          if (textDiv.textContent) chatContainer.appendChild(textDiv);
        }

        // Code block
        const codeBox = document.createElement("pre");
        const codeElem = document.createElement("code");
        codeElem.textContent = match[1].trim();
        codeBox.appendChild(codeElem);

        const copyBtn = document.createElement("button");
        copyBtn.className = "copy-btn";
        copyBtn.textContent = "Copy";
        copyBtn.onclick = () => {
          navigator.clipboard.writeText(codeElem.textContent);
          copyBtn.textContent = "Copied!";
          setTimeout(() => copyBtn.textContent = "Copy", 1000);
        };

        const wrapper = document.createElement("div");
        wrapper.className = "message bot";
        wrapper.appendChild(codeBox);
        wrapper.appendChild(copyBtn);
        chatContainer.appendChild(wrapper);

        lastIndex = match.index + match[0].length;
      }

      // Remaining plain text
      if (lastIndex < receivedText.length) {
        const textDiv = document.createElement("div");
        textDiv.className = "message bot";
        textDiv.textContent = receivedText.slice(lastIndex).trim();
        if (textDiv.textContent) chatContainer.appendChild(textDiv);
      }

      chatContainer.scrollTop = chatContainer.scrollHeight;
      return;
    }

    // Append streaming characters
    receivedText += event.data;
    botDiv.textContent += event.data;
    chatContainer.scrollTop = chatContainer.scrollHeight;
  };

  es.onerror = () => {
    es.close();
    cursor.remove();
  };
}
</script>

</body>
</html>
